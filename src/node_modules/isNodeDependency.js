
var path = require ('path');
var fs = require ('fs-extra');

var DELIMIT = process.platform == 'win32' ? '\\' : '/';

function isNodeDependency (context, source, target) {
    var frags = target.split (DELIMIT);
    var refFrags = source.split (DELIMIT);
    var sameFromRoot = 0;
    for (var i=0,j=refFrags.length; i<j; i++) {
        if (frags[i] !== refFrags[i])
            break;
        sameFromRoot++;
    }
    var modFrags = frags.slice (sameFromRoot, frags.length-1);
    // if (modFrags.length)
        modFrags.push (path.parse (frags[frags.length-1]).name);

    var isDep = false;
    for (var i=refFrags.length-1, j=sameFromRoot-1; i>j; i--) {
        var frag = refFrags[i];
        try {
            var packageText = fs.readFileSync (
                refFrags.slice (0, i).join (DELIMIT)
              + DELIMIT
              + 'package.json'
            );
            var packageInfo = JSON.parse (packageText);
            if (
                packageInfo.dependencies
             && Object.hasOwnProperty.call (packageInfo.dependencies, frags[sameFromRoot])
            ) {
                // dependency module - do not use the root path!
                isDep = true;
                modFrags = [ frags[sameFromRoot] ];
                root = [];
            }
        } catch (err) {
            if (err.code == 'ENOENT')
                continue;
            return context.logger.fatal (err, 'failed to resolve dependencies');
        }

        // we only care about the first dependent directory entered
        break;
    }

    return isDep;
}

module.exports = isNodeDependency;
